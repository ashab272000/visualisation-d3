<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Covid 19 Viewer</title>
    <script src='https://d3js.org/d3.v7.min.js'></script>

</head>

<body>
    <div style="display: flex;">
        <div id="map__container">
            <svg id="map" width="400" height="300"></svg>
            <div style="display: flex;">
                <div>
                    <label for="map__select">Display:</label>

                    <select name="map__select" id="map__select">
                        <option value="total_cases">Cases</option>
                        <option value="total_tests">Tests</option>
                        <option value="total_deaths">Deaths</option>
                        <option value="total_vaccinations">Vaccinations</option>
                        <!-- <option value="total_vaccinations">Vaccinations</option> -->
                    </select>
                </div>
                <div>
                    <label for="map__by__select">By:</label>

                    <select name="map__by__select" id="map__by__select">
                        <option value="number">Number</option>
                        <option value="percentage">Percentage Of Population</option>
                    </select>
                </div>
            </div>
        </div>
        <div id="pie__container">
            <svg id="pie" width="400" height="300"></svg>
        </div>

    </div>
    <div id="line__container">
        <div id="line__chart__container">
        </div>
        <label for="line__select1">Line 1:</label>

        <select name="line__select1" id="line__select1">
            <option value="new_cases">New Cases</option>
            <option value="new_deaths">New Deaths</option>
            <option value="people_vaccinated">People Vaccinated</option>
        </select>
        <label for="line__select2">Line 2:</label>

        <select name="line__select2" id="line__select2">
            <option value="people_vaccinated">People Vaccinated</option>
            <option value="new_cases">New Cases</option>
            <option value="new_deaths">New Deaths</option>
        </select>
    </div>
    <div>
        <div id="scatter__chart__container">
        </div>
        <label for="scatter_select">Y Value: </label>

        <select name="scatter_select" id="scatter_select">
            <option value="total_vaccinations">Vaccinations</option>
            <option value="total_cases">Total Cases</option>
            <option value="total_deaths">Total Deaths</option>
        </select>
    </div>
    <script>
        (async () => {

            // ---------------------------------
            // ---------------------------------Pie Chart Values---------------------------------
            // ---------------------------------

            const pieSvg = d3.select('#pie'),
                pieSvgWidth = +pieSvg.attr("width"),
                pieSvgHeight = +pieSvg.attr("height");

            const pieRadius = Math.min(pieSvgWidth, pieSvgHeight) / 2;
            const pieColor = d3.scaleOrdinal().range(d3.schemeSet3);

            const pie = d3.pie()
                .sort(null);

            const arc = d3.arc()
                .innerRadius(pieRadius - 100)
                .outerRadius(pieRadius - 50);

            // ---------------------------------
            // ---------------------------------Line Chart values---------------------------------
            // ---------------------------------

            const margin = { top: 50, right: 150, bottom: 50, left: 150 };

            // ---------------------------------
            // ---------------------------------Scatter values---------------------------------
            // ---------------------------------

            const scatterMargin = { top: 10, right: 30, bottom: 60, left: 100 },
                scatterWidth = 800 - margin.left - margin.right,
                scatterHeight = 400 - margin.top - margin.bottom;

            // ---------------------------------
            // ---------------------------------Map values---------------------------------
            // ---------------------------------
            const mapSvg = d3.select("#map"),
                mapWidth = +mapSvg.attr("width"),
                mapHeight = +mapSvg.attr("height");

            // Setting background of Map
            mapSvg.style('background', '#1e1e1e')
            const path = d3.geoPath();
            const projection = d3.geoMercator()
                .scale(70)
                .center([0, 20])
                .translate([mapWidth / 2, mapHeight / 2]);


            const loadDataset = async () => {
                const topoData = await d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson");

                console.log('Loaded topo data')
                const covid = await d3.csv('./data/owid-covid-data.csv', (d) => {
                    d.date = d3.timeParse("%Y-%m-%d")(d.date)
                    return d
                });
                console.log(covid[0])
                console.log('Loaded covid data')

                return [covid, topoData]
            }
            const allData = await loadDataset()
            const dataset = allData[0]
            const topoData = allData[1]
            const countryCodes = topoData.features.map((e) => e.id)

            const getTotalsByCountry = ({ date = null, key = 'total_cases' }) => {
                const data = []
                for (let i = 0; i < countryCodes.length; i++) {
                    let filtered = dataset.filter((e) => { return e['iso_code'] == countryCodes[i] })
                    if (filtered.length == 0) {
                        continue
                    }

                    if (date == null) {
                        let value = 0
                        let gdp = 0
                        let pop = filtered[0]['population']
                        for (let j = filtered.length - 1; j >= 0; j--) {
                            value = filtered[j][key]

                            if (parseInt(value) > 0) {
                                value = parseInt(value)
                                gdp = filtered[j]['gdp_per_capita']
                                break;
                            }
                        }
                        data.push({ 'id': countryCodes[i], 'value': value, 'pop': pop, 'gdp': gdp })
                    }

                }
                return data

            }
            // const totalCases = getTotalCasesByCountry()
            let mapColorScale = d3.scaleSequential().domain([0, 50000000]).interpolator(d3.interpolateBlues);
            // console.log(dataset)
            const getMapValues = () => {
                const key = d3.select('#map__select').property("value")
                const byKey = d3.select('#map__by__select').property("value")
                // console.log(value)
                const totals = getTotalsByCountry({ key })
                let values = []
                if (byKey == 'percentage') {
                    totals.forEach(e => { e.value = e.value / e.pop })
                }
                values = totals.map(e => e.value)

                mapColorScale = d3.scaleSequential().domain([d3.quantile(values, .05), d3.quantile(values, 0.95)]).interpolator(d3.interpolateBlues);

                return totals
            }

            const onMapSelectChange = () => {
                const totals = getMapValues()
                mapSvg
                    .select('g')
                    .selectAll('path')
                    .attr("fill", function (d) {

                        const scale = totals.find(e => { return e.id == d.id })
                        return mapColorScale(scale ? scale.value : 0)
                    })
            }

            const createMap = async () => {

                const values = getMapValues()

                mapSvg.append("g")
                    .selectAll("path")
                    .data(topoData.features)
                    .join("path")
                    // draw each country
                    .attr("d", d3.geoPath()
                        .projection(projection)
                    )
                    // set the color of each country by a certain selected value
                    .attr("fill", function (d) {

                        // d.total = dataset[d.id] || 0;
                        const scale = values.find(e => { return e.id == d.id })
                        return mapColorScale(scale ? scale.value : 0)
                    })
            }

            // TODO: Create Pie Chart
            const createPie = async () => {
                const svg = d3.select('#pie').append("g").attr("transform", `translate(${pieSvgWidth / 2},${pieSvgHeight / 2})`);
                // const data = getTotalsByCountry({ key:  })
                var path = svg
                    .selectAll(".pie-chart")
                    .append('g')
                    .attr("class", 'pie-chart')
                    .data((d) => {
                        return pie(data)
                    })
                    .enter()
                    .append("path")
                    .transition()
                    .ease(d3.easeLinear)
                    .duration((d) => {
                        return ((d.endAngle - d.startAngle) / Math.PI) * 1000
                    })
                    .delay((d) => {
                        return ((d.startAngle / Math.PI) * 1000)
                    })
                    .attr('d', arc)
                    .attr("fill", function (d, i) { return color(i); })
                    .attrTween("d", function (d, i, n) {
                        console.log("arctween")
                        console.log(d.startAngle)
                        console.log(d.endAngle)
                        var i = d3.interpolate(d.startAngle, d.endAngle);
                        return function (t) {
                            d.endAngle = i(t);
                            return arc(d);
                        }
                    })

            }

            // -------------------------- Creating Line Chart --------------------------
            const createLineChart = async () => {
                const data = dataset.filter(e => e.iso_code == 'OWID_WRL')
                const rectWidth = 800
                const rectHeight = 400

                width = rectWidth - margin.left - margin.right,
                    height = rectHeight - margin.top - margin.bottom;

                const svg = d3
                    .select('#line__chart__container')
                    .append("svg")
                    .attr("width", rectWidth)
                    .attr("height", rectHeight)
                    .append("g")


                // Setting up X axis
                var x = d3.scaleTime()
                    .domain(d3.extent(data, function (d) { return d.date; }))
                    .range([0, width]);
                svg.append("g")
                    .attr('id', 'line__chart__x__axis')
                    .attr("transform", `translate(${margin.left}, ${height + margin.top})`)
                    .call(d3.axisBottom(x));

                // Setting Up Left Y axis
                // People Vaccinated
                var y1 = d3.scaleLinear()
                    .domain([0, d3.max(data, (d) => +d.people_vaccinated)])
                    .range([height, 0]);
                svg.append("g")
                    .attr('id', 'line__chart__y1__axis')
                    .attr("transform", `translate(${margin.left}, ${margin.top})`)
                    .call(d3.axisLeft(y1));

                // Setting up right Y Axis
                // New Cases
                var y2 = d3.scaleLinear()
                    .domain([0, d3.max(data, (d) => +d.new_cases)])
                    .range([height, 0]);
                svg.append("g")
                    .attr('id', 'line__chart__y2__axis')
                    .attr("transform", `translate(${margin.left + width},${margin.top})`)
                    .call(d3.axisRight(y2));

                // Create Line Chart for Y1
                svg.append("path")
                    .attr('id', "line_path1")
                    .datum(data)
                    .attr("fill", "none")
                    .attr("stroke", "green")
                    .attr("stroke-width", 1.5)
                    .attr("d", d3.line()
                        .x(function (d) { return x(d.date) + margin.left })
                        .y(function (d) { return y1(d.people_vaccinated) + margin.top })
                    )

                svg.append("text")
                    .attr("class", "y1_label")
                    // .attr("text-anchor", "end")
                    .attr("x", -(300))
                    .attr("y", 20)
                    .attr('transform', `rotate(-90)`)
                    .text("Number of people vaccinated");

                // Create Line Chart for Y2
                svg.append("path")
                    .attr('id', "line_path2")
                    .datum(data)
                    .attr("fill", "none")
                    .attr("stroke", "steelblue")
                    .attr("stroke-width", 1.5)
                    .attr("d", d3.line()
                        .x(function (d) { return x(d.date) + margin.left })
                        .y(function (d) { return y2(d.new_cases) + margin.top })
                    )

                svg.append("text")
                    .attr("class", "y2_label")
                    // .attr("text-anchor", "end")
                    .attr("x", -(300))
                    .attr("y", width + margin.left + 120)
                    .attr('transform', `rotate(-90)`)
                    .text("Number of people vaccinated");
            }

            const updateLineChart = () => {
                // Get Values from the change
                const line1SelectValue = d3.select('#line__select1').property('value')
                const line1SelectText = d3.select('#line__select1 option:checked').text()
                const line2SelectValue = d3.select('#line__select2').property('value')
                const line2SelectText = d3.select('#line__select2 option:checked').text()

                const svg = d3.select('#line__chart__container').select('svg')

                // get data
                const data = dataset.filter(e => e.iso_code == 'OWID_WRL')

                // Setting up right Y Axis
                var x = d3.scaleTime()
                    .domain(d3.extent(data, function (d) { return d.date; }))
                    .range([0, width]);
                // People Vaccinated
                var y1 = d3.scaleLinear()
                    .domain([0, d3.max(data, (d) => +d[line1SelectValue])])
                    .range([height, 0]);
                svg
                    .select('#line__chart__y1__axis')
                    .call(d3.axisLeft(y1));

                // New Cases
                var y2 = d3.scaleLinear()
                    .domain([0, d3.max(data, (d) => +d[line2SelectValue])])
                    .range([height, 0]);
                svg.select('#line__chart__y2__axis')
                    .call(d3.axisRight(y2));

                // Update Line1 Path
                svg.select("#line_path1")
                    .datum(data)
                    .attr("d", d3.line()
                        .x(function (d) { return x(d.date) + margin.left })
                        .y(function (d) { return y1(d[line1SelectValue]) + margin.top })
                    )

                console.log("showkat gada")

                svg.select("#line_path2")
                    .datum(data)
                    .attr("d", d3.line()
                        .x(function (d) { return x(d.date) + margin.left })
                        .y(function (d) { return y2(d[line2SelectValue]) + margin.top })
                    )


                svg.select(".y1_label")
                    .attr("x", -(300))
                    .attr("y", 20)
                    .attr('transform', `rotate(-90)`)
                    .text(`Number of ${line1SelectText}`);

                svg.select(".y2_label")
                    .attr("x", -(300))
                    .attr("y", width + margin.left + 120)
                    .attr('transform', `rotate(-90)`)
                    .text(`Number of ${line2SelectText}`);

            }

            const createGdpChart = async () => {
                let data = getTotalsByCountry({ key: 'people_vaccinated' })
                data = data.filter(d => d.gdp > 0)
                const svg = d3
                    .select('#scatter__chart__container')
                    .append("svg")
                    .attr("width", scatterWidth + scatterMargin.left + scatterMargin.right)
                    .attr("height", scatterHeight + scatterMargin.top + scatterMargin.bottom)
                    .append("g")
                    .attr('transform', `translate(${scatterMargin.left}, ${scatterMargin.right})`)

                var x = d3.scaleLinear()
                    .domain([d3.min(data, d => +d.gdp), d3.max(data, d => +d.gdp)])
                    .range([0, scatterWidth])
                svg.append("g")
                    .attr('id', 'scatter__x__axis')
                    .attr("transform", "translate(0," + scatterHeight + ")")
                    .call(d3.axisBottom(x));
                const maxY = d3.max(data, (d) => +(d.value / d.pop))
                var y = d3.scaleLinear()
                    .domain([0, maxY])
                    .range([scatterHeight, 0]);
                svg.append("g")
                    .attr('id', 'scatter__y__axis')
                    .call(d3.axisLeft(y));

                // Scatter GDP
                svg.append("g")
                    .selectAll("dot")
                    .data(data)
                    .enter()
                    .append("circle")
                    .attr("cx", function (d) { return x(d.gdp); })
                    .attr("cy", function (d) { return y(d.value / d.pop); })
                    .attr("r", 2)
                    .style("fill", "#69b3a2")

            }

            const updateScatterPlot = () => {
                const value = d3.select("#scatter_select").property("value")
                let data = getTotalsByCountry({ key: value })
                data = data.filter(d => d.gdp > 0)

                const svg = d3
                    .select('#scatter__chart__container')
                    .select("svg")
                    .select("g")

                var x = d3.scaleLinear()
                    .domain([d3.min(data, d => +d.gdp), d3.max(data, d => +d.gdp)])
                    .range([0, scatterWidth])
                svg.select('#scatter__x__axis')
                    .call(d3.axisBottom(x));
                const maxY = d3.max(data, (d) => +(d.value / d.pop))
                var y = d3.scaleLinear()
                    .domain([0, maxY])
                    .range([scatterHeight, 0]);
                svg.select('#scatter__y__axis')
                    .call(d3.axisLeft(y));

                // Scatter GDP
                svg.selectAll("circle")
                    .data(data)
                    .attr("cx", function (d) { return x(d.gdp); })
                    .attr("cy", function (d) { return y(d.value / d.pop); })
                    .attr("r", 2)
                    .style("fill", "#69b3a2")


            }
            createMap()
            d3.select("#map__select").on('change', onMapSelectChange)
            d3.select("#map__by__select").on('change', onMapSelectChange)
            createLineChart()
            d3.select("#line__select1").on('change', updateLineChart)
            d3.select("#line__select2").on('change', updateLineChart)
            createGdpChart()
            d3.select("#scatter_select").on('change', updateScatterPlot)


        })()
    </script>
</body>

</html>